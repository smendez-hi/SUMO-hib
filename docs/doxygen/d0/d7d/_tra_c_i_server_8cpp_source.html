<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SUMO - Simulation of Urban MObility: TraCIServer.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="../../dir_75b82e7e4a5feb05200b9ad7adf06257.html">home</a>&nbsp;&raquo;&nbsp;<a class="el" href="../../dir_46b8f36974b309f038ffc35aa047a32b.html">boni</a>&nbsp;&raquo;&nbsp;<a class="el" href="../../dir_52e5be8ca53cec2b5437a8ba83e8e4f0.html">Desktop</a>&nbsp;&raquo;&nbsp;<a class="el" href="../../dir_7de3ce0f65e0314f747915173f89e60e.html">DanielTouched</a>&nbsp;&raquo;&nbsp;<a class="el" href="../../dir_a0096e276045b3ff0719c75e0b3c59bf.html">sumo-0.14.0</a>&nbsp;&raquo;&nbsp;<a class="el" href="../../dir_e9b8d709919855cd07b0394009af2578.html">src</a>&nbsp;&raquo;&nbsp;<a class="el" href="../../dir_321e1e012996dae673e7b6b67cce78a7.html">traci-server</a>
  </div>
</div>
<div class="contents">
<h1>TraCIServer.cpp</h1><a href="../../d0/d7d/_tra_c_i_server_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/****************************************************************************/</span>
<a name="l00016"></a>00016 <span class="comment">/****************************************************************************/</span>
<a name="l00017"></a>00017 <span class="comment">// SUMO, Simulation of Urban MObility; see http://sumo.sourceforge.net/</span>
<a name="l00018"></a>00018 <span class="comment">// Copyright (C) 2001-2012 DLR (http://www.dlr.de/) and contributors</span>
<a name="l00019"></a>00019 <span class="comment">/****************************************************************************/</span>
<a name="l00020"></a>00020 <span class="comment">//</span>
<a name="l00021"></a>00021 <span class="comment">//   This file is part of SUMO.</span>
<a name="l00022"></a>00022 <span class="comment">//   SUMO is free software: you can redistribute it and/or modify</span>
<a name="l00023"></a>00023 <span class="comment">//   it under the terms of the GNU General Public License as published by</span>
<a name="l00024"></a>00024 <span class="comment">//   the Free Software Foundation, either version 3 of the License, or</span>
<a name="l00025"></a>00025 <span class="comment">//   (at your option) any later version.</span>
<a name="l00026"></a>00026 <span class="comment">//</span>
<a name="l00027"></a>00027 <span class="comment">/****************************************************************************/</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="comment">// ===========================================================================</span>
<a name="l00030"></a>00030 <span class="comment">// included modules</span>
<a name="l00031"></a>00031 <span class="comment">// ===========================================================================</span>
<a name="l00032"></a>00032 <span class="preprocessor">#ifdef _MSC_VER</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="../../d3/d99/windows__config_8h.html">windows_config.h</a>&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#else</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="../../db/d16/config_8h.html">config.h</a>&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#endif</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#ifndef NO_TRACI</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>
<a name="l00042"></a>00042 <span class="preprocessor">#ifdef HAVE_PYTHON</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#include &lt;Python.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#endif</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;map&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;<a class="code" href="../../da/ddd/socket_8h.html">foreign/tcpip/socket.h</a>&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;<a class="code" href="../../d8/d6b/storage_8h.html">foreign/tcpip/storage.h</a>&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;<a class="code" href="../../d4/d64/_s_u_m_o_time_8h.html">utils/common/SUMOTime.h</a>&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;<a class="code" href="../../d6/d78/_dijkstra_router_t_t_8h.html">utils/common/DijkstraRouterTT.h</a>&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;<a class="code" href="../../dd/d01/_named_object_cont_8h.html">utils/common/NamedObjectCont.h</a>&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;<a class="code" href="../../d6/d68/_rand_helper_8h.html">utils/common/RandHelper.h</a>&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;<a class="code" href="../../d4/df7/_msg_handler_8h.html">utils/common/MsgHandler.h</a>&gt;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;<a class="code" href="../../d9/d51/_helpers_h_b_e_f_a_8h.html">utils/common/HelpersHBEFA.h</a>&gt;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;<a class="code" href="../../de/d1a/_helpers_harmonoise_8h.html">utils/common/HelpersHarmonoise.h</a>&gt;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &lt;<a class="code" href="../../d0/d7a/_s_u_m_o_vehicle_parameter_8h.html">utils/common/SUMOVehicleParameter.h</a>&gt;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &lt;<a class="code" href="../../de/d0a/_point_of_interest_8h.html">utils/shapes/PointOfInterest.h</a>&gt;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;<a class="code" href="../../d3/df9/_shape_container_8h.html">utils/shapes/ShapeContainer.h</a>&gt;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &lt;<a class="code" href="../../da/d08/_polygon_8h.html">utils/shapes/Polygon.h</a>&gt;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;<a class="code" href="../../d5/de9/_x_m_l_sub_sys_8h.html">utils/xml/XMLSubSys.h</a>&gt;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &lt;<a class="code" href="../../d9/dfa/_m_s_net_8h.html">microsim/MSNet.h</a>&gt;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &lt;<a class="code" href="../../de/d52/_m_s_vehicle_control_8h.html">microsim/MSVehicleControl.h</a>&gt;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &lt;<a class="code" href="../../dc/d38/_m_s_vehicle_8h.html">microsim/MSVehicle.h</a>&gt;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &lt;<a class="code" href="../../da/dea/_m_s_edge_8h.html">microsim/MSEdge.h</a>&gt;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &lt;<a class="code" href="../../d1/d82/_m_s_junction_control_8h.html">microsim/MSJunctionControl.h</a>&gt;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &lt;<a class="code" href="../../d8/d61/_m_s_junction_8h.html">microsim/MSJunction.h</a>&gt;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &lt;<a class="code" href="../../d3/d9c/_m_s_edge_control_8h.html">microsim/MSEdgeControl.h</a>&gt;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &lt;<a class="code" href="../../d3/d38/_m_s_lane_8h.html">microsim/MSLane.h</a>&gt;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &lt;<a class="code" href="../../d6/dbe/_m_s_globals_8h.html">microsim/MSGlobals.h</a>&gt;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &lt;<a class="code" href="../../d0/df9/_m_s_t_l_logic_control_8h.html">microsim/traffic_lights/MSTLLogicControl.h</a>&gt;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html">TraCIConstants.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/dff/_tra_c_i_server_8h.html">TraCIServer.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dd1/_tra_c_i_server_a_p_i___induction_loop_8h.html">TraCIServerAPI_InductionLoop.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/da3/_tra_c_i_server_a_p_i___junction_8h.html">TraCIServerAPI_Junction.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/da8/_tra_c_i_server_a_p_i___lane_8h.html">TraCIServerAPI_Lane.h</a>&quot;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="../../da/dbf/_tra_c_i_server_a_p_i___me_me_detector_8h.html">TraCIServerAPI_MeMeDetector.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d90/_tra_c_i_server_a_p_i___t_l_s_8h.html">TraCIServerAPI_TLS.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/da4/_tra_c_i_server_a_p_i___vehicle_8h.html">TraCIServerAPI_Vehicle.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d42/_tra_c_i_server_a_p_i___vehicle_type_8h.html">TraCIServerAPI_VehicleType.h</a>&quot;</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dc7/_tra_c_i_server_a_p_i___route_8h.html">TraCIServerAPI_Route.h</a>&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d86/_tra_c_i_server_a_p_i___p_o_i_8h.html">TraCIServerAPI_POI.h</a>&quot;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d16/_tra_c_i_server_a_p_i___polygon_8h.html">TraCIServerAPI_Polygon.h</a>&quot;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d49/_tra_c_i_server_a_p_i___edge_8h.html">TraCIServerAPI_Edge.h</a>&quot;</span>
<a name="l00086"></a>00086 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/df3/_tra_c_i_server_a_p_i___simulation_8h.html">TraCIServerAPI_Simulation.h</a>&quot;</span>
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 <span class="preprocessor">#ifdef CHECK_MEMORY_LEAKS</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="../../d7/d8d/debug__new_8h.html">foreign/nvwa/debug_new.h</a>&gt;</span>
<a name="l00090"></a>00090 <span class="preprocessor">#endif // CHECK_MEMORY_LEAKS</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">// ===========================================================================</span>
<a name="l00094"></a>00094 <span class="comment">// used namespaces</span>
<a name="l00095"></a>00095 <span class="comment">// ===========================================================================</span>
<a name="l00096"></a>00096 <span class="keyword">namespace </span>traci {
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="comment">// ===========================================================================</span>
<a name="l00099"></a>00099 <span class="comment">// static member definitions</span>
<a name="l00100"></a>00100 <span class="comment">// ===========================================================================</span>
<a name="l00101"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a9f77bfe6b827694c758e27a1bf40f9e9">00101</a> <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html">TraCIServer</a>* <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">TraCIServer::myInstance</a> = 0;
<a name="l00102"></a>00102 <span class="keywordtype">bool</span> <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a07c2f5b8f4ed53dfc958f12cd9d8361b">TraCIServer::myDoCloseConnection</a> = <span class="keyword">false</span>;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="comment">// ===========================================================================</span>
<a name="l00106"></a>00106 <span class="comment">// method definitions</span>
<a name="l00107"></a>00107 <span class="comment">// ===========================================================================</span>
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 <span class="keywordtype">void</span>
<a name="l00110"></a>00110 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a9f77bfe6b827694c758e27a1bf40f9e9" title="Initialises the server.">TraCIServer::openSocket</a>(<span class="keyword">const</span> std::map&lt;int, CmdExecutor&gt; &amp;execs) {
<a name="l00111"></a>00111     <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a> == 0) {
<a name="l00112"></a>00112         <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a07c2f5b8f4ed53dfc958f12cd9d8361b">myDoCloseConnection</a> &amp;&amp; <a class="code" href="../../db/d31/class_options_cont.html#aeb57cb173789bce33943574837e6221c" title="Retrieves the options.">OptionsCont::getOptions</a>().getInt(<span class="stringliteral">&quot;remote-port&quot;</span>) != 0) {
<a name="l00113"></a>00113             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a> = <span class="keyword">new</span> <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aa9423030e6c9f1f6df58152384eaec4b">traci::TraCIServer</a>(<a class="code" href="../../db/d31/class_options_cont.html#aeb57cb173789bce33943574837e6221c" title="Retrieves the options.">OptionsCont::getOptions</a>().getInt(<span class="stringliteral">&quot;remote-port&quot;</span>));
<a name="l00114"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aa9423030e6c9f1f6df58152384eaec4b">00114</a>             <span class="keywordflow">for</span> (std::map&lt;int, CmdExecutor&gt;::const_iterator i = execs.begin(); i != execs.end(); ++i) {
<a name="l00115"></a>00115                 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[i-&gt;first] = i-&gt;second;
<a name="l00116"></a>00116             }
<a name="l00117"></a>00117         }
<a name="l00118"></a>00118     }
<a name="l00119"></a>00119 }
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="comment">/*****************************************************************************/</span>
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aa9423030e6c9f1f6df58152384eaec4b">TraCIServer::TraCIServer</a>(<span class="keywordtype">int</span> port)
<a name="l00124"></a>00124     : mySocket(0), myTargetTime(0), myDoingSimStep(false), myHaveWarnedDeprecation(false), myAmEmbedded(port == 0) {
<a name="l00125"></a>00125     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5a74734726be08553ee9689d5da6f808">myVehicleStateChanges</a>[<a class="code" href="../../dc/d5d/class_m_s_net.html#a19e1d800f4d19bae756b5597a6101d7aafb4b35253378a605abdbd85d4ddb7185" title="The vehicle was built, but has not yet departed.">MSNet::VEHICLE_STATE_BUILT</a>] = std::vector&lt;std::string&gt;();
<a name="l00126"></a>00126     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5a74734726be08553ee9689d5da6f808">myVehicleStateChanges</a>[<a class="code" href="../../dc/d5d/class_m_s_net.html#a19e1d800f4d19bae756b5597a6101d7aa39efff936f6732814154fae748ff2d36" title="The vehicle has departed (was inserted into the network).">MSNet::VEHICLE_STATE_DEPARTED</a>] = std::vector&lt;std::string&gt;();
<a name="l00127"></a>00127     myVehicleStateChanges[<a class="code" href="../../dc/d5d/class_m_s_net.html#a19e1d800f4d19bae756b5597a6101d7aaa3ea58aa11aa3ecaae715c3c9bdaeedf" title="The vehicle started to teleport.">MSNet::VEHICLE_STATE_STARTING_TELEPORT</a>] = std::vector&lt;std::string&gt;();
<a name="l00128"></a>00128     myVehicleStateChanges[<a class="code" href="../../dc/d5d/class_m_s_net.html#a19e1d800f4d19bae756b5597a6101d7aa336bab3325308deaa49e790a54591710" title="The vehicle ended being teleported.">MSNet::VEHICLE_STATE_ENDING_TELEPORT</a>] = std::vector&lt;std::string&gt;();
<a name="l00129"></a>00129     myVehicleStateChanges[<a class="code" href="../../dc/d5d/class_m_s_net.html#a19e1d800f4d19bae756b5597a6101d7aa5d0e007c167346ffd29804e0027f4223" title="The vehicle arrived at his destination (is deleted).">MSNet::VEHICLE_STATE_ARRIVED</a>] = std::vector&lt;std::string&gt;();
<a name="l00130"></a>00130     myVehicleStateChanges[<a class="code" href="../../dc/d5d/class_m_s_net.html#a19e1d800f4d19bae756b5597a6101d7aa0ba914f641fd4f72f1e7ce393abcf682" title="The vehicle got a new route.">MSNet::VEHICLE_STATE_NEWROUTE</a>] = std::vector&lt;std::string&gt;();
<a name="l00131"></a>00131     <a class="code" href="../../dc/d5d/class_m_s_net.html#a2024ec4396b66fd698bb581fc5cc3408" title="Returns the pointer to the unique instance of MSNet (singleton).">MSNet::getInstance</a>()-&gt;<a class="code" href="../../dc/d5d/class_m_s_net.html#a9812cb65739225e06b41764bdc1c56d9" title="Adds a vehicle states listener.">addVehicleStateListener</a>(<span class="keyword">this</span>);
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a8a127fe9592a7f233ed5bfdea70dff24">CMD_GET_INDUCTIONLOOP_VARIABLE</a>] = &amp;<a class="code" href="../../d6/d4b/class_tra_c_i_server_a_p_i___induction_loop.html#aa6d89e34b9541f949724d736299e7871" title="Processes a get value command (Command 0xa0: Get Induction Loop Variable).">TraCIServerAPI_InductionLoop::processGet</a>;
<a name="l00134"></a>00134     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#ae7720408c339a65bb1d7920776e7f4e6">CMD_GET_MULTI_ENTRY_EXIT_DETECTOR_VARIABLE</a>] = &amp;<a class="code" href="../../d7/d89/class_tra_c_i_server_a_p_i___me_me_detector.html#a8fc97519bfd75f025a79e1e4a8e42c3d" title="Processes a get value command (Command 0xa1: Get MeMeDetector Variable).">TraCIServerAPI_MeMeDetector::processGet</a>;
<a name="l00135"></a>00135     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a23a5713b2efa147f104b003c10d07ac6">CMD_GET_TL_VARIABLE</a>] = &amp;<a class="code" href="../../df/d9a/class_tra_c_i_server_a_p_i___t_l_s.html#aeb16b2b36b53820effd2b600e835ecdc" title="Processes a get value command (Command 0xa2: Get Traffic Lights Variable).">TraCIServerAPI_TLS::processGet</a>;
<a name="l00136"></a>00136     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a45d28d5e51861aadcb6628654e5eb216">CMD_SET_TL_VARIABLE</a>] = &amp;<a class="code" href="../../df/d9a/class_tra_c_i_server_a_p_i___t_l_s.html#ab1175bd09c1bf69920d01f81ae2e8356" title="Processes a set value command (Command 0xc2: Change Traffic Lights State).">TraCIServerAPI_TLS::processSet</a>;
<a name="l00137"></a>00137     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#ae82c59889f44f40b0df6f1c41e00cb67">CMD_GET_LANE_VARIABLE</a>] = &amp;<a class="code" href="../../dd/d65/class_tra_c_i_server_a_p_i___lane.html#a46da79436f34ad75be27cd223a68708e" title="Processes a get value command (Command 0xa3: Get Lane Variable).">TraCIServerAPI_Lane::processGet</a>;
<a name="l00138"></a>00138     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#adf59516cf5e0e33c6456e79e41c066cb">CMD_SET_LANE_VARIABLE</a>] = &amp;<a class="code" href="../../dd/d65/class_tra_c_i_server_a_p_i___lane.html#a7d2af583f1061c9813b921e9490e2b00" title="Processes a set value command (Command 0xc3: Change Lane State).">TraCIServerAPI_Lane::processSet</a>;
<a name="l00139"></a>00139     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a8327578e1d375be0cda35067c23d0542">CMD_GET_VEHICLE_VARIABLE</a>] = &amp;<a class="code" href="../../d9/d85/class_tra_c_i_server_a_p_i___vehicle.html#a4ac98a631ffe2a17d1084d789c3ab5ff" title="Processes a get value command (Command 0xa4: Get Vehicle Variable).">TraCIServerAPI_Vehicle::processGet</a>;
<a name="l00140"></a>00140     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a4daee312282fa61ce2b2c9e19dc71fab">CMD_SET_VEHICLE_VARIABLE</a>] = &amp;<a class="code" href="../../d9/d85/class_tra_c_i_server_a_p_i___vehicle.html#a2b5716f79a99cadf1c8b132a6c16d5fb" title="Processes a set value command (Command 0xc4: Change Vehicle State).">TraCIServerAPI_Vehicle::processSet</a>;
<a name="l00141"></a>00141     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#ae6a517ede4227e23146523b5390e07a5">CMD_GET_VEHICLETYPE_VARIABLE</a>] = &amp;<a class="code" href="../../d0/d89/class_tra_c_i_server_a_p_i___vehicle_type.html#ae7fa58b0bec0ac3dbfd4b234f711d50d" title="Processes a get value command (Command 0xa5: Get Vehicle Type Variable).">TraCIServerAPI_VehicleType::processGet</a>;
<a name="l00142"></a>00142     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#ab5485e8ea7e4ac013adc23328137a179">CMD_SET_VEHICLETYPE_VARIABLE</a>] = &amp;<a class="code" href="../../d0/d89/class_tra_c_i_server_a_p_i___vehicle_type.html#a007ad9a64039d9894705890d2b5d1949" title="Processes a set value command (Command 0xc5: Change Vehicle Type State).">TraCIServerAPI_VehicleType::processSet</a>;
<a name="l00143"></a>00143     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a4b9ab406e73542e88dfcf44d3d736a83">CMD_GET_ROUTE_VARIABLE</a>] = &amp;<a class="code" href="../../d5/da6/class_tra_c_i_server_a_p_i___route.html#a3957c565fedd31dfb8716b0a65b8d101" title="Processes a get value command (Command 0xa6: Get Route Variable).">TraCIServerAPI_Route::processGet</a>;
<a name="l00144"></a>00144     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#af919cb89a8a561aff0896e66b5b5319a">CMD_SET_ROUTE_VARIABLE</a>] = &amp;<a class="code" href="../../d5/da6/class_tra_c_i_server_a_p_i___route.html#a05c2edfc7e19ac2492817c5507a09bdc" title="Processes a set value command (Command 0xc6: Change Route State).">TraCIServerAPI_Route::processSet</a>;
<a name="l00145"></a>00145     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a725c1c8d88140ccd66d2c78a72ab7c75">CMD_GET_POI_VARIABLE</a>] = &amp;<a class="code" href="../../df/d16/class_tra_c_i_server_a_p_i___p_o_i.html#a31cc464ebd2f00190fa4e39cac76404a" title="Processes a get value command (Command 0xa7: Get PoI Variable).">TraCIServerAPI_POI::processGet</a>;
<a name="l00146"></a>00146     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#ab75171b37a51f872525267e699d527cf">CMD_SET_POI_VARIABLE</a>] = &amp;<a class="code" href="../../df/d16/class_tra_c_i_server_a_p_i___p_o_i.html#aff8b806b4501dbc404e892a4231fee7a" title="Processes a set value command (Command 0xc7: Change PoI State).">TraCIServerAPI_POI::processSet</a>;
<a name="l00147"></a>00147     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a404ce6a209165786b246406df4aead28">CMD_GET_POLYGON_VARIABLE</a>] = &amp;<a class="code" href="../../d4/d5b/class_tra_c_i_server_a_p_i___polygon.html#a514646415af59a10a23bcc0b77cbaa0b" title="Processes a get value command (Command 0xa8: Get Polygon Variable).">TraCIServerAPI_Polygon::processGet</a>;
<a name="l00148"></a>00148     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a9a5b7a862e0e503918cdc066f3458e3b">CMD_SET_POLYGON_VARIABLE</a>] = &amp;<a class="code" href="../../d4/d5b/class_tra_c_i_server_a_p_i___polygon.html#a2f7d3cd76517bae4a31c0e0c181fcf74" title="Processes a set value command (Command 0xc8: Change Polygon State).">TraCIServerAPI_Polygon::processSet</a>;
<a name="l00149"></a>00149     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a19fb63fc78fed848a258aa23b138ff8d">CMD_GET_JUNCTION_VARIABLE</a>] = &amp;<a class="code" href="../../d0/d61/class_tra_c_i_server_a_p_i___junction.html#a40a344c1d2a9b026ed35b821ee4e1c80" title="Processes a get value command (Command 0xa9: Get Junction Variable).">TraCIServerAPI_Junction::processGet</a>;
<a name="l00150"></a>00150     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#aa893eb800437ce3ecf5fe24ca693a953">CMD_GET_EDGE_VARIABLE</a>] = &amp;<a class="code" href="../../d0/d8f/class_tra_c_i_server_a_p_i___edge.html#aa6fcf264c2cf40de834fe6e26f8a493a" title="Processes a get value command (Command 0xaa: Get Edge Variable).">TraCIServerAPI_Edge::processGet</a>;
<a name="l00151"></a>00151     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a28a6f61ca698fbf35fa06f94366e5ff9">CMD_SET_EDGE_VARIABLE</a>] = &amp;<a class="code" href="../../d0/d8f/class_tra_c_i_server_a_p_i___edge.html#aadfd65cd698a84a5b3f986baa5c11508" title="Processes a set value command (Command 0xca: Change Edge State).">TraCIServerAPI_Edge::processSet</a>;
<a name="l00152"></a>00152     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a59701651aaf3a84c12530259646846de">CMD_GET_SIM_VARIABLE</a>] = &amp;<a class="code" href="../../dd/d18/class_tra_c_i_server_a_p_i___simulation.html#a9ff493e27dfe1903b8be75a7079496b4" title="Processes a get value command (Command 0xaa: Get Edge Variable).">TraCIServerAPI_Simulation::processGet</a>;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a07c2f5b8f4ed53dfc958f12cd9d8361b">myDoCloseConnection</a> = <span class="keyword">false</span>;
<a name="l00155"></a>00155 
<a name="l00156"></a>00156     <span class="comment">// display warning if internal lanes are not used</span>
<a name="l00157"></a>00157     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/de7/class_m_s_globals.html#afab897d0ff315c0853f3dfad1b617d8a" title="Information whether the simulation regards internal lanes.">MSGlobals::gUsingInternalLanes</a>) {
<a name="l00158"></a>00158         <a class="code" href="../../d4/df7/_msg_handler_8h.html#a6875e463bd2d24f027eba135e7a5fdfa">WRITE_WARNING</a>(<span class="stringliteral">&quot;Starting TraCI without using internal lanes!&quot;</span>);
<a name="l00159"></a>00159         <a class="code" href="../../d7/df6/class_msg_handler.html#a6768d06edccb4152db554fe5a14abdfb" title="Returns the instance to add warnings to.">MsgHandler::getWarningInstance</a>()-&gt;<a class="code" href="../../d7/df6/class_msg_handler.html#a1b299e2ebb028e3fbd879cac607a4790" title="adds a new error to the list">inform</a>(<span class="stringliteral">&quot;Vehicles will jump over junctions.&quot;</span>, <span class="keyword">false</span>);
<a name="l00160"></a>00160         <a class="code" href="../../d7/df6/class_msg_handler.html#a6768d06edccb4152db554fe5a14abdfb" title="Returns the instance to add warnings to.">MsgHandler::getWarningInstance</a>()-&gt;<a class="code" href="../../d7/df6/class_msg_handler.html#a1b299e2ebb028e3fbd879cac607a4790" title="adds a new error to the list">inform</a>(<span class="stringliteral">&quot;Use without option --no-internal-links to avoid unexpected behavior&quot;</span>, <span class="keyword">false</span>);
<a name="l00161"></a>00161     }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a0d0ac94042e1774ae123043ddd8814f8">myAmEmbedded</a>) {
<a name="l00164"></a>00164         <span class="keywordflow">try</span> {
<a name="l00165"></a>00165             <a class="code" href="../../d4/df7/_msg_handler_8h.html#a4ff0c29263eba441db6e23204912ff7f">WRITE_MESSAGE</a>(<span class="stringliteral">&quot;***Starting server on port &quot;</span> + <a class="code" href="../../d8/d08/_to_string_8h.html#a18065e342d6bcbee25664108f38176f9">toString</a>(port) + <span class="stringliteral">&quot; ***&quot;</span>);
<a name="l00166"></a>00166             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5170d7a76742ea9d3c20266ea463550c" title="socket on which server is listening on">mySocket</a> = <span class="keyword">new</span> tcpip::Socket(port);
<a name="l00167"></a>00167             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5170d7a76742ea9d3c20266ea463550c" title="socket on which server is listening on">mySocket</a>-&gt;accept();
<a name="l00168"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#abf961ca031931b691b82b1184c35334a">00168</a>             <span class="comment">// When got here, a client has connected</span>
<a name="l00169"></a>00169         } <span class="keywordflow">catch</span> (tcpip::SocketException&amp; e) {
<a name="l00170"></a>00170             <span class="keywordflow">throw</span> <a class="code" href="../../da/d18/class_process_error.html">ProcessError</a>(e.what());
<a name="l00171"></a>00171         }
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173 }
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="comment">/*****************************************************************************/</span>
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#abf961ca031931b691b82b1184c35334a">TraCIServer::~TraCIServer</a>() {
<a name="l00178"></a>00178     <a class="code" href="../../dc/d5d/class_m_s_net.html#a2024ec4396b66fd698bb581fc5cc3408" title="Returns the pointer to the unique instance of MSNet (singleton).">MSNet::getInstance</a>()-&gt;<a class="code" href="../../dc/d5d/class_m_s_net.html#a0e27d7798c482f3b1694623a9b088798" title="Removes a vehicle states listener.">removeVehicleStateListener</a>(<span class="keyword">this</span>);
<a name="l00179"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a8541a0945b91310923cc8bd22a3de5a9">00179</a>     <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5170d7a76742ea9d3c20266ea463550c" title="socket on which server is listening on">mySocket</a> != NULL) {
<a name="l00180"></a>00180         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5170d7a76742ea9d3c20266ea463550c" title="socket on which server is listening on">mySocket</a>-&gt;close();
<a name="l00181"></a>00181         <span class="keyword">delete</span> <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5170d7a76742ea9d3c20266ea463550c" title="socket on which server is listening on">mySocket</a>;
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183 }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185 <span class="comment">/*****************************************************************************/</span>
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 <span class="keywordtype">void</span>
<a name="l00188"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a977df73152d27f94234e07707c02b98a">00188</a> <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a8541a0945b91310923cc8bd22a3de5a9" title="Called if a vehicle changes its state.">TraCIServer::vehicleStateChanged</a>(<span class="keyword">const</span> <a class="code" href="../../db/d61/class_s_u_m_o_vehicle.html" title="Representation of a vehicle.">SUMOVehicle</a>* <span class="keyword">const</span> vehicle, <a class="code" href="../../dc/d5d/class_m_s_net.html#a19e1d800f4d19bae756b5597a6101d7a" title="Definition of a vehicle state.">MSNet::VehicleState</a> to) {
<a name="l00189"></a>00189     <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a07c2f5b8f4ed53dfc958f12cd9d8361b">myDoCloseConnection</a> || <a class="code" href="../../db/d31/class_options_cont.html#aeb57cb173789bce33943574837e6221c" title="Retrieves the options.">OptionsCont::getOptions</a>().getInt(<span class="stringliteral">&quot;remote-port&quot;</span>) == 0) {
<a name="l00190"></a>00190         <span class="keywordflow">return</span>;
<a name="l00191"></a>00191     }
<a name="l00192"></a>00192     myVehicleStateChanges[to].push_back(vehicle-&gt;<a class="code" href="../../db/d61/class_s_u_m_o_vehicle.html#a42cdd9b7723e52037bbc5d76bacf266f" title="Get the vehicle&amp;#39;s ID.">getID</a>());
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 <span class="comment">/*****************************************************************************/</span>
<a name="l00196"></a>00196 <span class="keywordtype">void</span>
<a name="l00197"></a>00197 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a977df73152d27f94234e07707c02b98a" title="process all commands until a simulation step is wanted">TraCIServer::processCommandsUntilSimStep</a>(<a class="code" href="../../d4/d64/_s_u_m_o_time_8h.html#ae665eda71d2654ce49eea540f154a3c7">SUMOTime</a> step) {
<a name="l00198"></a>00198     <span class="keywordflow">try</span> {
<a name="l00199"></a>00199         <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a> == 0) {
<a name="l00200"></a>00200             <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a07c2f5b8f4ed53dfc958f12cd9d8361b">myDoCloseConnection</a> &amp;&amp; <a class="code" href="../../db/d31/class_options_cont.html#aeb57cb173789bce33943574837e6221c" title="Retrieves the options.">OptionsCont::getOptions</a>().getInt(<span class="stringliteral">&quot;remote-port&quot;</span>) != 0) {
<a name="l00201"></a>00201                 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a> = <span class="keyword">new</span> <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aa9423030e6c9f1f6df58152384eaec4b">traci::TraCIServer</a>(<a class="code" href="../../db/d31/class_options_cont.html#aeb57cb173789bce33943574837e6221c" title="Retrieves the options.">OptionsCont::getOptions</a>().getInt(<span class="stringliteral">&quot;remote-port&quot;</span>));
<a name="l00202"></a>00202             } <span class="keywordflow">else</span> {
<a name="l00203"></a>00203                 <span class="keywordflow">return</span>;
<a name="l00204"></a>00204             }
<a name="l00205"></a>00205         }
<a name="l00206"></a>00206         <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myAmEmbedded || step &lt; myInstance-&gt;<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#abaf54fac3b9f5ded6e3e4f146e7a8799">myTargetTime</a>) {
<a name="l00207"></a>00207             <span class="keywordflow">return</span>;
<a name="l00208"></a>00208         }
<a name="l00209"></a>00209         <span class="comment">// Simulation should run until</span>
<a name="l00210"></a>00210         <span class="comment">// 1. end time reached or</span>
<a name="l00211"></a>00211         <span class="comment">// 2. got CMD_CLOSE or</span>
<a name="l00212"></a>00212         <span class="comment">// 3. Client closes socket connection</span>
<a name="l00213"></a>00213         <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myDoingSimStep) {
<a name="l00214"></a>00214             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;postProcessSimulationStep2();
<a name="l00215"></a>00215             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myDoingSimStep = <span class="keyword">false</span>;
<a name="l00216"></a>00216         }
<a name="l00217"></a>00217         <span class="keywordflow">while</span> (!<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a07c2f5b8f4ed53dfc958f12cd9d8361b">myDoCloseConnection</a>) {
<a name="l00218"></a>00218             <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myInputStorage.valid_pos()) {
<a name="l00219"></a>00219                 <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myOutputStorage.size() &gt; 0) {
<a name="l00220"></a>00220                     <span class="comment">// send out all answers as one storage</span>
<a name="l00221"></a>00221                     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;mySocket-&gt;sendExact(<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myOutputStorage);
<a name="l00222"></a>00222                 }
<a name="l00223"></a>00223                 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myInputStorage.reset();
<a name="l00224"></a>00224                 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myOutputStorage.reset();
<a name="l00225"></a>00225                 <span class="comment">// Read a message</span>
<a name="l00226"></a>00226                 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;mySocket-&gt;receiveExact(<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myInputStorage);
<a name="l00227"></a>00227             }
<a name="l00228"></a>00228             <span class="keywordflow">while</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myInputStorage.valid_pos() &amp;&amp; !<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a07c2f5b8f4ed53dfc958f12cd9d8361b">myDoCloseConnection</a>) {
<a name="l00229"></a>00229                 <span class="comment">// dispatch each command</span>
<a name="l00230"></a>00230                 <span class="keywordtype">int</span> cmd = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;dispatchCommand();
<a name="l00231"></a>00231                 <span class="keywordflow">if</span> (cmd == <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#affa501f61facb91d6c42b6ed4b184dfa">CMD_SIMSTEP2</a>) {
<a name="l00232"></a>00232                     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myDoingSimStep = <span class="keyword">true</span>;
<a name="l00233"></a>00233                     <span class="keywordflow">for</span> (std::map&lt;<a class="code" href="../../dc/d5d/class_m_s_net.html#a19e1d800f4d19bae756b5597a6101d7a" title="Definition of a vehicle state.">MSNet::VehicleState</a>, std::vector&lt;std::string&gt; &gt;::iterator i = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myVehicleStateChanges.begin(); i != <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myVehicleStateChanges.end(); ++i) {
<a name="l00234"></a>00234                         (*i).second.clear();
<a name="l00235"></a>00235                     }
<a name="l00236"></a>00236                     <span class="keywordflow">return</span>;
<a name="l00237"></a>00237                 }
<a name="l00238"></a>00238             }
<a name="l00239"></a>00239         }
<a name="l00240"></a>00240         <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a07c2f5b8f4ed53dfc958f12cd9d8361b">myDoCloseConnection</a> &amp;&amp; <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myOutputStorage.size() &gt; 0) {
<a name="l00241"></a>00241             <span class="comment">// send out all answers as one storage</span>
<a name="l00242"></a>00242             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;mySocket-&gt;sendExact(<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myOutputStorage);
<a name="l00243"></a>00243         }
<a name="l00244"></a>00244         <span class="keywordflow">for</span> (std::map&lt;<a class="code" href="../../dc/d5d/class_m_s_net.html#a19e1d800f4d19bae756b5597a6101d7a" title="Definition of a vehicle state.">MSNet::VehicleState</a>, std::vector&lt;std::string&gt; &gt;::iterator i = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myVehicleStateChanges.begin(); i != <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myVehicleStateChanges.end(); ++i) {
<a name="l00245"></a>00245             (*i).second.clear();
<a name="l00246"></a>00246         }
<a name="l00247"></a>00247     } <span class="keywordflow">catch</span> (std::invalid_argument&amp; e) {
<a name="l00248"></a>00248         <span class="keywordflow">throw</span> <a class="code" href="../../da/d18/class_process_error.html">ProcessError</a>(e.what());
<a name="l00249"></a>00249     } <span class="keywordflow">catch</span> (<a class="code" href="../../db/d79/class_tra_c_i_exception.html">TraCIException</a>&amp; e) {
<a name="l00250"></a>00250         <span class="keywordflow">throw</span> <a class="code" href="../../da/d18/class_process_error.html">ProcessError</a>(e.what());
<a name="l00251"></a>00251     } <span class="keywordflow">catch</span> (tcpip::SocketException&amp; e) {
<a name="l00252"></a>00252         <span class="keywordflow">throw</span> <a class="code" href="../../da/d18/class_process_error.html">ProcessError</a>(e.what());
<a name="l00253"></a>00253     }
<a name="l00254"></a>00254     <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a> != NULL) {
<a name="l00255"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1f64a107fe270af034e238f598d497c5">00255</a>         <span class="keyword">delete</span> <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>;
<a name="l00256"></a>00256         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a> = 0;
<a name="l00257"></a>00257         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a07c2f5b8f4ed53dfc958f12cd9d8361b">myDoCloseConnection</a> = <span class="keyword">true</span>;
<a name="l00258"></a>00258     }
<a name="l00259"></a>00259 }
<a name="l00260"></a>00260 
<a name="l00261"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a9576b589cbb0cd2024530d4a125da539">00261</a> <span class="comment">/*****************************************************************************/</span>
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="keywordtype">bool</span>
<a name="l00264"></a>00264 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1f64a107fe270af034e238f598d497c5" title="check whether close was requested">TraCIServer::wasClosed</a>() {
<a name="l00265"></a>00265     <span class="keywordflow">return</span> <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a07c2f5b8f4ed53dfc958f12cd9d8361b">myDoCloseConnection</a>;
<a name="l00266"></a>00266 }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268 
<a name="l00269"></a>00269 <span class="keywordtype">void</span>
<a name="l00270"></a>00270 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a9576b589cbb0cd2024530d4a125da539" title="request termination of connection">TraCIServer::close</a>() {
<a name="l00271"></a>00271     <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a> != 0) {
<a name="l00272"></a>00272         <span class="keyword">delete</span> <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>;
<a name="l00273"></a>00273         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a> = 0;
<a name="l00274"></a>00274         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a07c2f5b8f4ed53dfc958f12cd9d8361b">myDoCloseConnection</a> = <span class="keyword">true</span>;
<a name="l00275"></a>00275     }
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 <span class="comment">/*****************************************************************************/</span>
<a name="l00279"></a>00279 
<a name="l00280"></a>00280 <span class="preprocessor">#ifdef HAVE_PYTHON</span>
<a name="l00281"></a>00281 <span class="preprocessor"></span><span class="comment">// ===========================================================================</span>
<a name="l00282"></a>00282 <span class="comment">// python functions (traciemb module)</span>
<a name="l00283"></a>00283 <span class="comment">// ===========================================================================</span>
<a name="l00284"></a>00284 <span class="keyword">static</span> PyObject*
<a name="l00285"></a>00285 traciemb_execute(PyObject* <span class="keyword">self</span>, PyObject* args) {
<a name="l00286"></a>00286     <span class="keyword">const</span> <span class="keywordtype">char</span>* msg;
<a name="l00287"></a>00287     <span class="keywordtype">int</span> size;
<a name="l00288"></a>00288     <span class="keywordflow">if</span> (!PyArg_ParseTuple(args, <span class="stringliteral">&quot;s#&quot;</span>, &amp;msg, &amp;size)) {
<a name="l00289"></a>00289         <span class="keywordflow">return</span> NULL;
<a name="l00290"></a>00290     }
<a name="l00291"></a>00291     std::string result = traci::TraCIServer::execute(std::string(msg, size));
<a name="l00292"></a>00292     <span class="keywordflow">return</span> Py_BuildValue(<span class="stringliteral">&quot;s#&quot;</span>, result.c_str(), result.size());
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="keyword">static</span> PyMethodDef EmbMethods[] = {
<a name="l00296"></a>00296     {
<a name="l00297"></a>00297         <span class="stringliteral">&quot;execute&quot;</span>, traciemb_execute, METH_VARARGS,
<a name="l00298"></a>00298         <span class="stringliteral">&quot;Execute the given TraCI command and return the result.&quot;</span>
<a name="l00299"></a>00299     },
<a name="l00300"></a>00300     {NULL, NULL, 0, NULL}
<a name="l00301"></a>00301 };
<a name="l00302"></a>00302 
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 std::string
<a name="l00305"></a>00305 TraCIServer::execute(std::string cmd) {
<a name="l00306"></a>00306     <span class="keywordflow">try</span> {
<a name="l00307"></a>00307         <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a> == 0) {
<a name="l00308"></a>00308             <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a07c2f5b8f4ed53dfc958f12cd9d8361b">myDoCloseConnection</a>) {
<a name="l00309"></a>00309                 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a> = <span class="keyword">new</span> <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aa9423030e6c9f1f6df58152384eaec4b">traci::TraCIServer</a>();
<a name="l00310"></a>00310             } <span class="keywordflow">else</span> {
<a name="l00311"></a>00311                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00312"></a>00312             }
<a name="l00313"></a>00313         }
<a name="l00314"></a>00314         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myInputStorage.reset();
<a name="l00315"></a>00315         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myOutputStorage.reset();
<a name="l00316"></a>00316         <span class="keywordflow">for</span> (std::string::iterator i = cmd.begin(); i != cmd.end(); ++i) {
<a name="l00317"></a>00317             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myInputStorage.writeChar(*i);
<a name="l00318"></a>00318         }
<a name="l00319"></a>00319         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;dispatchCommand();
<a name="l00320"></a>00320         <span class="keywordflow">return</span> std::string(<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myOutputStorage.begin(), <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aea6b49b5ef202da896ab841297f05224" title="singleton instance of the server">myInstance</a>-&gt;myOutputStorage.end());
<a name="l00321"></a>00321     } <span class="keywordflow">catch</span> (std::invalid_argument&amp; e) {
<a name="l00322"></a>00322         <span class="keywordflow">throw</span> <a class="code" href="../../da/d18/class_process_error.html">ProcessError</a>(e.what());
<a name="l00323"></a>00323     } <span class="keywordflow">catch</span> (<a class="code" href="../../db/d79/class_tra_c_i_exception.html">TraCIException</a>&amp; e) {
<a name="l00324"></a>00324         <span class="keywordflow">throw</span> <a class="code" href="../../da/d18/class_process_error.html">ProcessError</a>(e.what());
<a name="l00325"></a>00325     } <span class="keywordflow">catch</span> (tcpip::SocketException&amp; e) {
<a name="l00326"></a>00326         <span class="keywordflow">throw</span> <a class="code" href="../../da/d18/class_process_error.html">ProcessError</a>(e.what());
<a name="l00327"></a>00327     }
<a name="l00328"></a>00328 }
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 <span class="keywordtype">void</span>
<a name="l00332"></a>00332 TraCIServer::runEmbedded(std::string pyFile) {
<a name="l00333"></a>00333     PyObject* pName, *pModule;
<a name="l00334"></a>00334     Py_Initialize();
<a name="l00335"></a>00335     Py_InitModule(<span class="stringliteral">&quot;traciemb&quot;</span>, EmbMethods);
<a name="l00336"></a>00336     <span class="keywordflow">if</span> (pyFile.length() &gt; 3 &amp;&amp; !pyFile.compare(pyFile.length() - 3, 3, <span class="stringliteral">&quot;.py&quot;</span>)) {
<a name="l00337"></a>00337         FILE* pFile = fopen(pyFile.c_str(), <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00338"></a>00338         PyRun_SimpleFile(pFile, pyFile.c_str());
<a name="l00339"></a>00339         fclose(pFile);
<a name="l00340"></a>00340     } <span class="keywordflow">else</span> {
<a name="l00341"></a>00341         pName = PyString_FromString(pyFile.c_str());
<a name="l00342"></a>00342         <span class="comment">/* Error checking of pName left out */</span>
<a name="l00343"></a>00343         pModule = PyImport_Import(pName);
<a name="l00344"></a>00344         Py_DECREF(pName);
<a name="l00345"></a>00345         <span class="keywordflow">if</span> (pModule == NULL) {
<a name="l00346"></a>00346             PyErr_Print();
<a name="l00347"></a>00347             <span class="keywordflow">throw</span> <a class="code" href="../../da/d18/class_process_error.html">ProcessError</a>(<span class="stringliteral">&quot;Failed to load \&quot;&quot;</span> + pyFile + <span class="stringliteral">&quot;\&quot;!&quot;</span>);
<a name="l00348"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a63dbe157487c7e6a5f287f5e0b1d06e8">00348</a>         }
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350     Py_Finalize();
<a name="l00351"></a>00351 }
<a name="l00352"></a>00352 <span class="preprocessor">#endif</span>
<a name="l00353"></a>00353 <span class="preprocessor"></span>
<a name="l00354"></a>00354 <span class="comment">/*****************************************************************************/</span>
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 <span class="keywordtype">int</span>
<a name="l00357"></a>00357 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a63dbe157487c7e6a5f287f5e0b1d06e8">TraCIServer::dispatchCommand</a>() {
<a name="l00358"></a>00358     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> commandStart = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.position();
<a name="l00359"></a>00359     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> commandLength = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readUnsignedByte();
<a name="l00360"></a>00360     <span class="keywordflow">if</span> (commandLength == 0) {
<a name="l00361"></a>00361         commandLength = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readInt();
<a name="l00362"></a>00362     }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364     <span class="keywordtype">int</span> commandId = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readUnsignedByte();
<a name="l00365"></a>00365     <span class="keywordtype">bool</span> success = <span class="keyword">false</span>;
<a name="l00366"></a>00366     <span class="comment">// dispatch commands</span>
<a name="l00367"></a>00367     <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>.find(commandId) != <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>.end()) {
<a name="l00368"></a>00368         success = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[commandId](*<span class="keyword">this</span>, <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>, <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a92cd157fe4df6c8b1522593d742cc31a">myOutputStorage</a>);
<a name="l00369"></a>00369     } <span class="keywordflow">else</span> {
<a name="l00370"></a>00370         <span class="keywordflow">switch</span> (commandId) {
<a name="l00371"></a>00371             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a8e73707083e5a68828275698eadeab50">CMD_GETVERSION</a>:
<a name="l00372"></a>00372                 success = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a9a72038657c1e4dc520fedcad7ec93e1">commandGetVersion</a>();
<a name="l00373"></a>00373                 <span class="keywordflow">break</span>;
<a name="l00374"></a>00374             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#affa501f61facb91d6c42b6ed4b184dfa">CMD_SIMSTEP2</a>: {
<a name="l00375"></a>00375                 <a class="code" href="../../d4/d64/_s_u_m_o_time_8h.html#ae665eda71d2654ce49eea540f154a3c7">SUMOTime</a> nextT = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readInt();
<a name="l00376"></a>00376                 success = <span class="keyword">true</span>;
<a name="l00377"></a>00377                 <span class="keywordflow">if</span> (nextT != 0) {
<a name="l00378"></a>00378                     myTargetTime = nextT;
<a name="l00379"></a>00379                 } <span class="keywordflow">else</span> {
<a name="l00380"></a>00380                     myTargetTime += <a class="code" href="../../d6/d1f/_s_u_m_o_time_8cpp.html#a462b4847ee7697f3bee34fce1df9f87c">DELTA_T</a>;
<a name="l00381"></a>00381                 }
<a name="l00382"></a>00382                 <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a0d0ac94042e1774ae123043ddd8814f8">myAmEmbedded</a>) {
<a name="l00383"></a>00383                     <a class="code" href="../../dc/d5d/class_m_s_net.html#a2024ec4396b66fd698bb581fc5cc3408" title="Returns the pointer to the unique instance of MSNet (singleton).">MSNet::getInstance</a>()-&gt;<a class="code" href="../../dc/d5d/class_m_s_net.html#a8b84bf53a83934a9c095067de02336f9" title="Performs a single simulation step.">simulationStep</a>();
<a name="l00384"></a>00384                     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#ada0f09e934e6456d95f3e1f5129cf45d">postProcessSimulationStep2</a>();
<a name="l00385"></a>00385                 }
<a name="l00386"></a>00386                 <span class="keywordflow">return</span> commandId;
<a name="l00387"></a>00387             }
<a name="l00388"></a>00388             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a0908ae0ea53f32f9e7bbb814b4ebc9b2">CMD_CLOSE</a>:
<a name="l00389"></a>00389                 success = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a34d19f1ebc91e36a8bdd209d1bae369c">commandCloseConnection</a>();
<a name="l00390"></a>00390                 <span class="keywordflow">break</span>;
<a name="l00391"></a>00391             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a1b1102bcb8d10eb1759b245526ce3896">CMD_POSITIONCONVERSION</a>: {
<a name="l00392"></a>00392                 <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a29390808d299a49680c7b82c0b351394">myHaveWarnedDeprecation</a>) {
<a name="l00393"></a>00393                     <a class="code" href="../../d4/df7/_msg_handler_8h.html#a6875e463bd2d24f027eba135e7a5fdfa">WRITE_WARNING</a>(<span class="stringliteral">&quot;Using old TraCI API, please update your client!&quot;</span>);
<a name="l00394"></a>00394                     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a29390808d299a49680c7b82c0b351394">myHaveWarnedDeprecation</a> = <span class="keyword">true</span>;
<a name="l00395"></a>00395                 }
<a name="l00396"></a>00396                 tcpip::Storage tempMsg;
<a name="l00397"></a>00397                 success = <a class="code" href="../../dd/d18/class_tra_c_i_server_a_p_i___simulation.html#ad5b6e3069fcbfd75087903008457bb65">TraCIServerAPI_Simulation::commandPositionConversion</a>(*<span class="keyword">this</span>, <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>, tempMsg, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a1b1102bcb8d10eb1759b245526ce3896">CMD_POSITIONCONVERSION</a>);
<a name="l00398"></a>00398                 <span class="keywordflow">if</span> (success) {
<a name="l00399"></a>00399                     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a1b1102bcb8d10eb1759b245526ce3896">CMD_POSITIONCONVERSION</a>, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a541fc8755958a227fe412e2df7fa31fa">RTYPE_OK</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00400"></a>00400                     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a92cd157fe4df6c8b1522593d742cc31a">myOutputStorage</a>.writeStorage(tempMsg);
<a name="l00401"></a>00401                 }
<a name="l00402"></a>00402             }
<a name="l00403"></a>00403             <span class="keywordflow">break</span>;
<a name="l00404"></a>00404             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#af69681565a80c646bfdf35fe312ba38e">CMD_ADDVEHICLE</a>:
<a name="l00405"></a>00405                 <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a29390808d299a49680c7b82c0b351394">myHaveWarnedDeprecation</a>) {
<a name="l00406"></a>00406                     <a class="code" href="../../d4/df7/_msg_handler_8h.html#a6875e463bd2d24f027eba135e7a5fdfa">WRITE_WARNING</a>(<span class="stringliteral">&quot;Using old TraCI API, please update your client!&quot;</span>);
<a name="l00407"></a>00407                     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a29390808d299a49680c7b82c0b351394">myHaveWarnedDeprecation</a> = <span class="keyword">true</span>;
<a name="l00408"></a>00408                 }
<a name="l00409"></a>00409                 success = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aaa354f21e1f9a28596e03a2da93923da">commandAddVehicle</a>();
<a name="l00410"></a>00410                 <span class="keywordflow">break</span>;
<a name="l00411"></a>00411             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a5be282748a440d3ebf7b973591e2f932">CMD_DISTANCEREQUEST</a>: {
<a name="l00412"></a>00412                 <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a29390808d299a49680c7b82c0b351394">myHaveWarnedDeprecation</a>) {
<a name="l00413"></a>00413                     <a class="code" href="../../d4/df7/_msg_handler_8h.html#a6875e463bd2d24f027eba135e7a5fdfa">WRITE_WARNING</a>(<span class="stringliteral">&quot;Using old TraCI API, please update your client!&quot;</span>);
<a name="l00414"></a>00414                     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a29390808d299a49680c7b82c0b351394">myHaveWarnedDeprecation</a> = <span class="keyword">true</span>;
<a name="l00415"></a>00415                 }
<a name="l00416"></a>00416                 tcpip::Storage tempMsg;
<a name="l00417"></a>00417                 success = <a class="code" href="../../dd/d18/class_tra_c_i_server_a_p_i___simulation.html#a20be3ea879ae9f1a3b5d35dfc34faa54">TraCIServerAPI_Simulation::commandDistanceRequest</a>(*<span class="keyword">this</span>, <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>, tempMsg, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a5be282748a440d3ebf7b973591e2f932">CMD_DISTANCEREQUEST</a>);
<a name="l00418"></a>00418                 <span class="keywordflow">if</span> (success) {
<a name="l00419"></a>00419                     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a5be282748a440d3ebf7b973591e2f932">CMD_DISTANCEREQUEST</a>, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a541fc8755958a227fe412e2df7fa31fa">RTYPE_OK</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00420"></a>00420                     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a92cd157fe4df6c8b1522593d742cc31a">myOutputStorage</a>.writeStorage(tempMsg);
<a name="l00421"></a>00421                 }
<a name="l00422"></a>00422             }
<a name="l00423"></a>00423             <span class="keywordflow">break</span>;
<a name="l00424"></a>00424             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a1c08dbf9ecec171fd5a8abdcf4bc1732">CMD_SUBSCRIBE_INDUCTIONLOOP_VARIABLE</a>:
<a name="l00425"></a>00425             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#aab7627756e25685ef8398633ca620bb2">CMD_SUBSCRIBE_MULTI_ENTRY_EXIT_DETECTOR_VARIABLE</a>:
<a name="l00426"></a>00426             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a89bdee3b9abb917a60549fd59fbb0030">CMD_SUBSCRIBE_TL_VARIABLE</a>:
<a name="l00427"></a>00427             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#afef1c73324fcdc35456aac81a7148543">CMD_SUBSCRIBE_LANE_VARIABLE</a>:
<a name="l00428"></a>00428             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a6ea1568c34b29442244baf42f2bdc099">CMD_SUBSCRIBE_VEHICLE_VARIABLE</a>:
<a name="l00429"></a>00429             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#ad0ac305c18e80d93f39441a8db700d73">CMD_SUBSCRIBE_VEHICLETYPE_VARIABLE</a>:
<a name="l00430"></a>00430             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a430ba00f89274e46a4c30b2cb99df0a0">CMD_SUBSCRIBE_ROUTE_VARIABLE</a>:
<a name="l00431"></a>00431             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a30482aa996155d083ce2ca8415ed70f0">CMD_SUBSCRIBE_POI_VARIABLE</a>:
<a name="l00432"></a>00432             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#abebcb9821a2d54a8cdcb094e4ca58b2b">CMD_SUBSCRIBE_POLYGON_VARIABLE</a>:
<a name="l00433"></a>00433             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a4a3b3f72cbb0e56c0497ec5cd41e9230">CMD_SUBSCRIBE_JUNCTION_VARIABLE</a>:
<a name="l00434"></a>00434             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#abd59649fa90019dd8b4171469b43e340">CMD_SUBSCRIBE_EDGE_VARIABLE</a>:
<a name="l00435"></a>00435             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#aa6ecd09a7f6cc9872956f06a84ab3caa">CMD_SUBSCRIBE_SIM_VARIABLE</a>:
<a name="l00436"></a>00436             <span class="keywordflow">case</span> <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#ab86891c2e946e90b4360ecad860825a7">CMD_SUBSCRIBE_GUI_VARIABLE</a>:
<a name="l00437"></a>00437                 success = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5ab0815e14f625c53d09b0cfad6cd8e2">addSubscription</a>(commandId);
<a name="l00438"></a>00438                 <span class="keywordflow">break</span>;
<a name="l00439"></a>00439             <span class="keywordflow">default</span>:
<a name="l00440"></a>00440                 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(commandId, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a31333391a4e82822d2c43e3928b6262c">RTYPE_NOTIMPLEMENTED</a>, <span class="stringliteral">&quot;Command not implemented in sumo&quot;</span>);
<a name="l00441"></a>00441         }
<a name="l00442"></a>00442     }
<a name="l00443"></a>00443     <span class="keywordflow">if</span> (!success) {
<a name="l00444"></a>00444         <span class="keywordflow">while</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.valid_pos() &amp;&amp; <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.position() &lt; commandStart + commandLength) {
<a name="l00445"></a>00445             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readChar();
<a name="l00446"></a>00446         }
<a name="l00447"></a>00447     }
<a name="l00448"></a>00448     <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.position() != commandStart + commandLength) {
<a name="l00449"></a>00449         std::ostringstream msg;
<a name="l00450"></a>00450         msg &lt;&lt; <span class="stringliteral">&quot;Wrong position in requestMessage after dispatching command.&quot;</span>;
<a name="l00451"></a>00451         msg &lt;&lt; <span class="stringliteral">&quot; Expected command length was &quot;</span> &lt;&lt; commandLength;
<a name="l00452"></a>00452         msg &lt;&lt; <span class="stringliteral">&quot; but &quot;</span> &lt;&lt; <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.position() - commandStart &lt;&lt; <span class="stringliteral">&quot; Bytes were read.&quot;</span>;
<a name="l00453"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#ada0f09e934e6456d95f3e1f5129cf45d">00453</a>         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(commandId, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a43465ba21de31f9ae2573e7ac5f24919">RTYPE_ERR</a>, msg.str());
<a name="l00454"></a>00454         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a07c2f5b8f4ed53dfc958f12cd9d8361b">myDoCloseConnection</a> = <span class="keyword">true</span>;
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456     <span class="keywordflow">return</span> commandId;
<a name="l00457"></a>00457 }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459 <span class="comment">/*****************************************************************************/</span>
<a name="l00460"></a>00460 
<a name="l00461"></a>00461 <span class="keywordtype">void</span>
<a name="l00462"></a>00462 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#ada0f09e934e6456d95f3e1f5129cf45d">TraCIServer::postProcessSimulationStep2</a>() {
<a name="l00463"></a>00463     <a class="code" href="../../d4/d64/_s_u_m_o_time_8h.html#ae665eda71d2654ce49eea540f154a3c7">SUMOTime</a> t = <a class="code" href="../../dc/d5d/class_m_s_net.html#a2024ec4396b66fd698bb581fc5cc3408" title="Returns the pointer to the unique instance of MSNet (singleton).">MSNet::getInstance</a>()-&gt;<a class="code" href="../../dc/d5d/class_m_s_net.html#a835b8056e154e434da624033500e1943" title="Returns the current simulation step (in s).">getCurrentTimeStep</a>();
<a name="l00464"></a>00464     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#affa501f61facb91d6c42b6ed4b184dfa">CMD_SIMSTEP2</a>, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a541fc8755958a227fe412e2df7fa31fa">RTYPE_OK</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00465"></a>00465     <span class="keywordtype">int</span> noActive = 0;
<a name="l00466"></a>00466     <span class="keywordflow">for</span> (std::vector&lt;Subscription&gt;::iterator i = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a8fbef6b38cae7e9f6220f1b08ab6a8e3">mySubscriptions</a>.begin(); i != <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a8fbef6b38cae7e9f6220f1b08ab6a8e3">mySubscriptions</a>.end();) {
<a name="l00467"></a>00467         <span class="keyword">const</span> Subscription&amp; s = *i;
<a name="l00468"></a>00468         <span class="keywordtype">bool</span> isArrivedVehicle = (s.commandId == <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a6ea1568c34b29442244baf42f2bdc099">CMD_SUBSCRIBE_VEHICLE_VARIABLE</a>) &amp;&amp; (find(myVehicleStateChanges[<a class="code" href="../../dc/d5d/class_m_s_net.html#a19e1d800f4d19bae756b5597a6101d7aa5d0e007c167346ffd29804e0027f4223" title="The vehicle arrived at his destination (is deleted).">MSNet::VEHICLE_STATE_ARRIVED</a>].begin(), myVehicleStateChanges[<a class="code" href="../../dc/d5d/class_m_s_net.html#a19e1d800f4d19bae756b5597a6101d7aa5d0e007c167346ffd29804e0027f4223" title="The vehicle arrived at his destination (is deleted).">MSNet::VEHICLE_STATE_ARRIVED</a>].end(), s.id) != myVehicleStateChanges[<a class="code" href="../../dc/d5d/class_m_s_net.html#a19e1d800f4d19bae756b5597a6101d7aa5d0e007c167346ffd29804e0027f4223" title="The vehicle arrived at his destination (is deleted).">MSNet::VEHICLE_STATE_ARRIVED</a>].end());
<a name="l00469"></a>00469         <span class="keywordflow">if</span> ((s.endTime &lt; t) || isArrivedVehicle) {
<a name="l00470"></a>00470             i = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a8fbef6b38cae7e9f6220f1b08ab6a8e3">mySubscriptions</a>.erase(i);
<a name="l00471"></a>00471             <span class="keywordflow">continue</span>;
<a name="l00472"></a>00472         }
<a name="l00473"></a>00473         ++i;
<a name="l00474"></a>00474         <span class="keywordflow">if</span> (s.beginTime &gt; t) {
<a name="l00475"></a>00475             <span class="keywordflow">continue</span>;
<a name="l00476"></a>00476         }
<a name="l00477"></a>00477         ++noActive;
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a92cd157fe4df6c8b1522593d742cc31a">myOutputStorage</a>.writeInt(noActive);
<a name="l00480"></a>00480     <span class="keywordflow">for</span> (std::vector&lt;Subscription&gt;::iterator i = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a8fbef6b38cae7e9f6220f1b08ab6a8e3">mySubscriptions</a>.begin(); i != <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a8fbef6b38cae7e9f6220f1b08ab6a8e3">mySubscriptions</a>.end(); ++i) {
<a name="l00481"></a>00481         <span class="keyword">const</span> Subscription&amp; s = *i;
<a name="l00482"></a>00482         <span class="keywordflow">if</span> (s.beginTime &gt; t) {
<a name="l00483"></a>00483             <span class="keywordflow">continue</span>;
<a name="l00484"></a>00484         }
<a name="l00485"></a>00485         tcpip::Storage into;
<a name="l00486"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a9a72038657c1e4dc520fedcad7ec93e1">00486</a>         std::string errors;
<a name="l00487"></a>00487         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aad2902b9f7df895e90c152c580ed877d">processSingleSubscription</a>(s, into, errors);
<a name="l00488"></a>00488         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a92cd157fe4df6c8b1522593d742cc31a">myOutputStorage</a>.writeStorage(into);
<a name="l00489"></a>00489     }
<a name="l00490"></a>00490 }
<a name="l00491"></a>00491 
<a name="l00492"></a>00492 <span class="comment">/*****************************************************************************/</span>
<a name="l00493"></a>00493 
<a name="l00494"></a>00494 <span class="keywordtype">bool</span>
<a name="l00495"></a>00495 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a9a72038657c1e4dc520fedcad7ec93e1">TraCIServer::commandGetVersion</a>() {
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     std::string sumoVersion = <a class="code" href="../../db/d16/config_8h.html#a698acb89e1bf5837b33c30ef35c30044">VERSION_STRING</a>;
<a name="l00498"></a>00498 
<a name="l00499"></a>00499     <span class="comment">// Prepare response</span>
<a name="l00500"></a>00500     tcpip::Storage answerTmp;
<a name="l00501"></a>00501 
<a name="l00502"></a>00502     answerTmp.writeInt(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a07fa3c69b8577074f150b63432efc227">TRACI_VERSION</a>);
<a name="l00503"></a>00503     answerTmp.writeString(std::string(<span class="stringliteral">&quot;SUMO &quot;</span>) + sumoVersion);
<a name="l00504"></a>00504 
<a name="l00505"></a>00505     <span class="comment">// When we get here, the response is stored in answerTmp -&gt; put into myOutputStorage</span>
<a name="l00506"></a>00506     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a8e73707083e5a68828275698eadeab50">CMD_GETVERSION</a>, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a541fc8755958a227fe412e2df7fa31fa">RTYPE_OK</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00507"></a>00507 
<a name="l00508"></a>00508     <span class="comment">// command length</span>
<a name="l00509"></a>00509     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a92cd157fe4df6c8b1522593d742cc31a">myOutputStorage</a>.writeUnsignedByte(1 + 1 + static_cast&lt;int&gt;(answerTmp.size()));
<a name="l00510"></a>00510     <span class="comment">// command type</span>
<a name="l00511"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a34d19f1ebc91e36a8bdd209d1bae369c">00511</a>     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a92cd157fe4df6c8b1522593d742cc31a">myOutputStorage</a>.writeUnsignedByte(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a8e73707083e5a68828275698eadeab50">CMD_GETVERSION</a>);
<a name="l00512"></a>00512     <span class="comment">// and the parameter dependant part</span>
<a name="l00513"></a>00513     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a92cd157fe4df6c8b1522593d742cc31a">myOutputStorage</a>.writeStorage(answerTmp);
<a name="l00514"></a>00514     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517 <span class="comment">/*****************************************************************************/</span>
<a name="l00518"></a>00518 
<a name="l00519"></a>00519 <span class="keywordtype">bool</span>
<a name="l00520"></a>00520 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a34d19f1ebc91e36a8bdd209d1bae369c">TraCIServer::commandCloseConnection</a>() {
<a name="l00521"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aaa354f21e1f9a28596e03a2da93923da">00521</a>     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a07c2f5b8f4ed53dfc958f12cd9d8361b">myDoCloseConnection</a> = <span class="keyword">true</span>;
<a name="l00522"></a>00522     <span class="comment">// write answer</span>
<a name="l00523"></a>00523     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a0908ae0ea53f32f9e7bbb814b4ebc9b2">CMD_CLOSE</a>, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a541fc8755958a227fe412e2df7fa31fa">RTYPE_OK</a>, <span class="stringliteral">&quot;Goodbye&quot;</span>);
<a name="l00524"></a>00524     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00525"></a>00525 }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527 <span class="comment">/*****************************************************************************/</span>
<a name="l00528"></a>00528 
<a name="l00529"></a>00529 <span class="keywordtype">bool</span>
<a name="l00530"></a>00530 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aaa354f21e1f9a28596e03a2da93923da">TraCIServer::commandAddVehicle</a>() {
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <span class="comment">// read parameters</span>
<a name="l00533"></a>00533     std::string vehicleId = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readString();
<a name="l00534"></a>00534     std::string vehicleTypeId = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readString();
<a name="l00535"></a>00535     std::string routeId = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readString();
<a name="l00536"></a>00536     std::string laneId = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readString();
<a name="l00537"></a>00537     <a class="code" href="../../db/d16/config_8h.html#a2481f526aef497857d2b407bc09129fd">SUMOReal</a> insertionPosition = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readFloat();
<a name="l00538"></a>00538     <a class="code" href="../../db/d16/config_8h.html#a2481f526aef497857d2b407bc09129fd">SUMOReal</a> insertionSpeed = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readFloat();
<a name="l00539"></a>00539 
<a name="l00540"></a>00540     <span class="comment">// find vehicleType</span>
<a name="l00541"></a>00541     <a class="code" href="../../de/da2/class_m_s_vehicle_type.html" title="The car-following model and parameter.">MSVehicleType</a>* vehicleType = <a class="code" href="../../dc/d5d/class_m_s_net.html#a2024ec4396b66fd698bb581fc5cc3408" title="Returns the pointer to the unique instance of MSNet (singleton).">MSNet::getInstance</a>()-&gt;<a class="code" href="../../dc/d5d/class_m_s_net.html#a5e74ee833cafefa74b84e2091ef135a3" title="Returns the vehicle control.">getVehicleControl</a>().<a class="code" href="../../db/d2f/class_m_s_vehicle_control.html#a95ddc958055c59d379d373aeb39621b5" title="Returns the named vehicle type or a sample from the named distribution.">getVType</a>(vehicleTypeId);
<a name="l00542"></a>00542     <span class="keywordflow">if</span> (!vehicleType) {
<a name="l00543"></a>00543         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#af69681565a80c646bfdf35fe312ba38e">CMD_ADDVEHICLE</a>, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a43465ba21de31f9ae2573e7ac5f24919">RTYPE_ERR</a>, <span class="stringliteral">&quot;Invalid vehicleTypeId: &#39;&quot;</span> + vehicleTypeId + <span class="stringliteral">&quot;&#39;&quot;</span>);
<a name="l00544"></a>00544         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     <span class="comment">// find route</span>
<a name="l00548"></a>00548     <span class="keyword">const</span> <a class="code" href="../../de/dd8/class_m_s_route.html">MSRoute</a>* route = <a class="code" href="../../de/dd8/class_m_s_route.html#a379e71c30ffbb0c2366b47f32014980f" title="Adds a route to the dictionary.">MSRoute::dictionary</a>(routeId);
<a name="l00549"></a>00549     <span class="keywordflow">if</span> (!route) {
<a name="l00550"></a>00550         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#af69681565a80c646bfdf35fe312ba38e">CMD_ADDVEHICLE</a>, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a43465ba21de31f9ae2573e7ac5f24919">RTYPE_ERR</a>, <span class="stringliteral">&quot;Invalid routeId: &#39;&quot;</span> + routeId + <span class="stringliteral">&quot;&#39;&quot;</span>);
<a name="l00551"></a>00551         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00552"></a>00552     }
<a name="l00553"></a>00553 
<a name="l00554"></a>00554     <span class="comment">// find lane</span>
<a name="l00555"></a>00555     <a class="code" href="../../d9/d16/class_m_s_lane.html" title="Representation of a lane in the micro simulation.">MSLane</a>* lane;
<a name="l00556"></a>00556     <span class="keywordflow">if</span> (laneId != <span class="stringliteral">&quot;&quot;</span>) {
<a name="l00557"></a>00557         lane = <a class="code" href="../../d9/d16/class_m_s_lane.html#a965f4a235ad88d59aa404c1054dafe75" title="Inserts a MSLane into the static dictionary Returns true if the key id isn&amp;#39;t...">MSLane::dictionary</a>(laneId);
<a name="l00558"></a>00558         <span class="keywordflow">if</span> (!lane) {
<a name="l00559"></a>00559             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#af69681565a80c646bfdf35fe312ba38e">CMD_ADDVEHICLE</a>, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a43465ba21de31f9ae2573e7ac5f24919">RTYPE_ERR</a>, <span class="stringliteral">&quot;Invalid laneId: &#39;&quot;</span> + laneId + <span class="stringliteral">&quot;&#39;&quot;</span>);
<a name="l00560"></a>00560             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00561"></a>00561         }
<a name="l00562"></a>00562     } <span class="keywordflow">else</span> {
<a name="l00563"></a>00563         lane = route-&gt;<a class="code" href="../../de/dd8/class_m_s_route.html#a50d81ec26eb67c4e0016b462e560e9c3">getEdges</a>()[0]-&gt;getLanes()[0];
<a name="l00564"></a>00564         <span class="keywordflow">if</span> (!lane) {
<a name="l00565"></a>00565             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a46dc7ae84992bfe62cc00731959a67f4">CMD_STOP</a>, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a43465ba21de31f9ae2573e7ac5f24919">RTYPE_ERR</a>, <span class="stringliteral">&quot;Could not find first lane of first edge in routeId &#39;&quot;</span> + routeId + <span class="stringliteral">&quot;&#39;&quot;</span>);
<a name="l00566"></a>00566             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00567"></a>00567         }
<a name="l00568"></a>00568     }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570     <span class="keywordflow">if</span> (&amp;lane-&gt;<a class="code" href="../../d9/d16/class_m_s_lane.html#ad689e4b858799c088f315442527a814f" title="Returns the lane&amp;#39;s edge.">getEdge</a>() != *route-&gt;<a class="code" href="../../de/dd8/class_m_s_route.html#a19df3c97135029c574956a7c0f88b9eb" title="Returns the begin of the list of edges to pass.">begin</a>()) {
<a name="l00571"></a>00571         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a46dc7ae84992bfe62cc00731959a67f4">CMD_STOP</a>, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a43465ba21de31f9ae2573e7ac5f24919">RTYPE_ERR</a>, <span class="stringliteral">&quot;The route must start at the edge the lane starts at.&quot;</span>);
<a name="l00572"></a>00572         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00573"></a>00573     }
<a name="l00574"></a>00574 
<a name="l00575"></a>00575     <span class="comment">// build vehicle</span>
<a name="l00576"></a>00576     <a class="code" href="../../d8/d51/class_s_u_m_o_vehicle_parameter.html" title="Structure representing possible vehicle parameter.">SUMOVehicleParameter</a>* vehicleParams = <span class="keyword">new</span> <a class="code" href="../../d8/d51/class_s_u_m_o_vehicle_parameter.html" title="Structure representing possible vehicle parameter.">SUMOVehicleParameter</a>();
<a name="l00577"></a>00577     vehicleParams-&gt;<a class="code" href="../../d8/d51/class_s_u_m_o_vehicle_parameter.html#ab39b1071f7e8b20fc560b30685069601" title="The vehicle&amp;#39;s id.">id</a> = vehicleId;
<a name="l00578"></a>00578     vehicleParams-&gt;<a class="code" href="../../d8/d51/class_s_u_m_o_vehicle_parameter.html#aded3ab5fa08e689297b7db36b24c3cf8" title="The vehicle&amp;#39;s departure time.">depart</a> = <a class="code" href="../../dc/d5d/class_m_s_net.html#a2024ec4396b66fd698bb581fc5cc3408" title="Returns the pointer to the unique instance of MSNet (singleton).">MSNet::getInstance</a>()-&gt;<a class="code" href="../../dc/d5d/class_m_s_net.html#a835b8056e154e434da624033500e1943" title="Returns the current simulation step (in s).">getCurrentTimeStep</a>() + 1;
<a name="l00579"></a>00579     <a class="code" href="../../d7/d90/class_m_s_vehicle.html" title="Representation of a vehicle in the micro simulation.">MSVehicle</a>* vehicle = <span class="keyword">static_cast&lt;</span><a class="code" href="../../d7/d90/class_m_s_vehicle.html" title="Representation of a vehicle in the micro simulation.">MSVehicle</a>*<span class="keyword">&gt;</span>(<a class="code" href="../../dc/d5d/class_m_s_net.html#a2024ec4396b66fd698bb581fc5cc3408" title="Returns the pointer to the unique instance of MSNet (singleton).">MSNet::getInstance</a>()-&gt;<a class="code" href="../../dc/d5d/class_m_s_net.html#a5e74ee833cafefa74b84e2091ef135a3" title="Returns the vehicle control.">getVehicleControl</a>().<a class="code" href="../../db/d2f/class_m_s_vehicle_control.html#a03be9f9e122e132fcc440afe5e324f1a" title="Builds a vehicle, increases the number of built vehicles.">buildVehicle</a>(vehicleParams, route, vehicleType));
<a name="l00580"></a>00580     <span class="keywordflow">if</span> (vehicle == NULL) {
<a name="l00581"></a>00581         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a46dc7ae84992bfe62cc00731959a67f4">CMD_STOP</a>, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a43465ba21de31f9ae2573e7ac5f24919">RTYPE_ERR</a>, <span class="stringliteral">&quot;Could not build vehicle&quot;</span>);
<a name="l00582"></a>00582         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00583"></a>00583     }
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     <span class="comment">// calculate speed</span>
<a name="l00586"></a>00586     <span class="keywordtype">float</span> clippedInsertionSpeed;
<a name="l00587"></a>00587     <span class="keywordflow">if</span> (insertionSpeed &lt; 0) {
<a name="l00588"></a>00588         clippedInsertionSpeed = (<a class="code" href="../../d4/dc3/classfloat.html">float</a>) <a class="code" href="../../da/dbd/_std_defs_8h.html#addea5df1107152d65231122e3dfad6fb">MIN2</a>(lane-&gt;<a class="code" href="../../d9/d16/class_m_s_lane.html#a8122139b83423d16c5228bdd280a21cc" title="Returns the lane&amp;#39;s maximum speed.">getMaxSpeed</a>(), vehicle-&gt;<a class="code" href="../../d9/dd6/class_m_s_base_vehicle.html#a52dce019121d18dc5680d36f2c645512" title="Returns the current maximum speed.">getMaxSpeed</a>());
<a name="l00589"></a>00589     } <span class="keywordflow">else</span> {
<a name="l00590"></a>00590         clippedInsertionSpeed = (<a class="code" href="../../d4/dc3/classfloat.html">float</a>) <a class="code" href="../../da/dbd/_std_defs_8h.html#a5f92f2a25e588fd5cddc7af24836046e">MIN3</a>(lane-&gt;<a class="code" href="../../d9/d16/class_m_s_lane.html#a8122139b83423d16c5228bdd280a21cc" title="Returns the lane&amp;#39;s maximum speed.">getMaxSpeed</a>(), vehicle-&gt;<a class="code" href="../../d9/dd6/class_m_s_base_vehicle.html#a52dce019121d18dc5680d36f2c645512" title="Returns the current maximum speed.">getMaxSpeed</a>(), insertionSpeed);
<a name="l00591"></a>00591     }
<a name="l00592"></a>00592 
<a name="l00593"></a>00593     <span class="comment">// insert vehicle into the dictionary</span>
<a name="l00594"></a>00594     <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d5d/class_m_s_net.html#a2024ec4396b66fd698bb581fc5cc3408" title="Returns the pointer to the unique instance of MSNet (singleton).">MSNet::getInstance</a>()-&gt;<a class="code" href="../../dc/d5d/class_m_s_net.html#a5e74ee833cafefa74b84e2091ef135a3" title="Returns the vehicle control.">getVehicleControl</a>().<a class="code" href="../../db/d2f/class_m_s_vehicle_control.html#a4a596b620fe88ac471ea9e905762ee44" title="Tries to insert the vehicle into the internal vehicle container.">addVehicle</a>(vehicle-&gt;<a class="code" href="../../d9/dd6/class_m_s_base_vehicle.html#af558b8f5379ec8f91cb47e9b7d2b7556" title="Returns the name of the vehicle.">getID</a>(), vehicle)) {
<a name="l00595"></a>00595         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#af69681565a80c646bfdf35fe312ba38e">CMD_ADDVEHICLE</a>, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a43465ba21de31f9ae2573e7ac5f24919">RTYPE_ERR</a>, <span class="stringliteral">&quot;Could not add vehicle to VehicleControl&quot;</span>);
<a name="l00596"></a>00596         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00597"></a>00597     }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <span class="comment">// try to emit</span>
<a name="l00600"></a>00600     <span class="keywordflow">if</span> (!lane-&gt;<a class="code" href="../../d9/d16/class_m_s_lane.html#ad710ffe491b964b015246849a1d6e2cc" title="Tries to insert the given vehicle with the given state (speed and pos).">isInsertionSuccess</a>(vehicle, clippedInsertionSpeed, insertionPosition, <span class="keyword">true</span>)) {
<a name="l00601"></a>00601         <a class="code" href="../../dc/d5d/class_m_s_net.html#a2024ec4396b66fd698bb581fc5cc3408" title="Returns the pointer to the unique instance of MSNet (singleton).">MSNet::getInstance</a>()-&gt;<a class="code" href="../../dc/d5d/class_m_s_net.html#a5e74ee833cafefa74b84e2091ef135a3" title="Returns the vehicle control.">getVehicleControl</a>().<a class="code" href="../../db/d2f/class_m_s_vehicle_control.html#a6088a11d7326c664fb854fc8bbc4ad9c" title="Deletes the vehicle.">deleteVehicle</a>(vehicle);
<a name="l00602"></a>00602         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#af69681565a80c646bfdf35fe312ba38e">CMD_ADDVEHICLE</a>, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a43465ba21de31f9ae2573e7ac5f24919">RTYPE_ERR</a>, <span class="stringliteral">&quot;Could not insert vehicle&quot;</span>);
<a name="l00603"></a>00603         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00604"></a>00604     }
<a name="l00605"></a>00605 
<a name="l00606"></a>00606     <span class="comment">// exec callback</span>
<a name="l00607"></a>00607     vehicle-&gt;<a class="code" href="../../d9/dd6/class_m_s_base_vehicle.html#acd40d634fb13dd8438c0553ba3c4120d" title="Called when the vehicle is inserted into the network.">onDepart</a>();
<a name="l00608"></a>00608 
<a name="l00609"></a>00609     <span class="comment">// create a reply message</span>
<a name="l00610"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">00610</a>     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#af69681565a80c646bfdf35fe312ba38e">CMD_ADDVEHICLE</a>, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a541fc8755958a227fe412e2df7fa31fa">RTYPE_OK</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00611"></a>00611 
<a name="l00612"></a>00612     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00613"></a>00613 }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615 
<a name="l00616"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a12ff01acb794c89921ff16774b94fc9b">00616</a> <span class="comment">/*****************************************************************************/</span>
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 <span class="keywordtype">void</span>
<a name="l00619"></a>00619 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">TraCIServer::writeStatusCmd</a>(<span class="keywordtype">int</span> commandId, <span class="keywordtype">int</span> status, <span class="keyword">const</span> std::string&amp; description) {
<a name="l00620"></a>00620     <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(commandId, status, description, <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a92cd157fe4df6c8b1522593d742cc31a">myOutputStorage</a>);
<a name="l00621"></a>00621 }
<a name="l00622"></a>00622 
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 <span class="keywordtype">void</span>
<a name="l00625"></a>00625 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">TraCIServer::writeStatusCmd</a>(<span class="keywordtype">int</span> commandId, <span class="keywordtype">int</span> status, <span class="keyword">const</span> std::string&amp; description, tcpip::Storage&amp; outputStorage) {
<a name="l00626"></a>00626     <span class="keywordflow">if</span> (status == <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a43465ba21de31f9ae2573e7ac5f24919">RTYPE_ERR</a>) {
<a name="l00627"></a>00627         <a class="code" href="../../d4/df7/_msg_handler_8h.html#a55c513aa2d151eee464020081d6688c2">WRITE_ERROR</a>(<span class="stringliteral">&quot;Answered with error to command &quot;</span> + <a class="code" href="../../d8/d08/_to_string_8h.html#a18065e342d6bcbee25664108f38176f9">toString</a>(commandId) + <span class="stringliteral">&quot;: &quot;</span> + description);
<a name="l00628"></a>00628     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a31333391a4e82822d2c43e3928b6262c">RTYPE_NOTIMPLEMENTED</a>) {
<a name="l00629"></a>00629         <a class="code" href="../../d4/df7/_msg_handler_8h.html#a55c513aa2d151eee464020081d6688c2">WRITE_ERROR</a>(<span class="stringliteral">&quot;Requested command not implemented (&quot;</span> + <a class="code" href="../../d8/d08/_to_string_8h.html#a18065e342d6bcbee25664108f38176f9">toString</a>(commandId) + <span class="stringliteral">&quot;): &quot;</span> + description);
<a name="l00630"></a>00630     }
<a name="l00631"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5ab0815e14f625c53d09b0cfad6cd8e2">00631</a>     outputStorage.writeUnsignedByte(1 + 1 + 1 + 4 + static_cast&lt;int&gt;(description.length())); <span class="comment">// command length</span>
<a name="l00632"></a>00632     outputStorage.writeUnsignedByte(commandId); <span class="comment">// command type</span>
<a name="l00633"></a>00633     outputStorage.writeUnsignedByte(status); <span class="comment">// status</span>
<a name="l00634"></a>00634     outputStorage.writeString(description); <span class="comment">// description</span>
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637 <span class="comment">/*****************************************************************************/</span>
<a name="l00638"></a>00638 
<a name="l00639"></a>00639 <span class="keywordtype">bool</span>
<a name="l00640"></a>00640 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5ab0815e14f625c53d09b0cfad6cd8e2">TraCIServer::addSubscription</a>(<span class="keywordtype">int</span> commandId) {
<a name="l00641"></a>00641     <a class="code" href="../../d4/d64/_s_u_m_o_time_8h.html#ae665eda71d2654ce49eea540f154a3c7">SUMOTime</a> beginTime = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readInt();
<a name="l00642"></a>00642     <a class="code" href="../../d4/d64/_s_u_m_o_time_8h.html#ae665eda71d2654ce49eea540f154a3c7">SUMOTime</a> endTime = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readInt();
<a name="l00643"></a>00643     std::string <span class="keywordtype">id</span> = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readString();
<a name="l00644"></a>00644     <span class="keywordtype">int</span> no = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readUnsignedByte();
<a name="l00645"></a>00645     std::vector&lt;int&gt; variables;
<a name="l00646"></a>00646     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; no; ++i) {
<a name="l00647"></a>00647         variables.push_back(<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a1764cac0439f3f1313aa23cd8a1da093">myInputStorage</a>.readUnsignedByte());
<a name="l00648"></a>00648     }
<a name="l00649"></a>00649     <span class="comment">// check subscribe/unsubscribe</span>
<a name="l00650"></a>00650     <span class="keywordtype">bool</span> ok = <span class="keyword">true</span>;
<a name="l00651"></a>00651     <span class="keywordflow">if</span> (variables.size() == 0) {
<a name="l00652"></a>00652         <span class="comment">// try unsubscribe</span>
<a name="l00653"></a>00653         <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
<a name="l00654"></a>00654         <span class="keywordflow">for</span> (std::vector&lt;Subscription&gt;::iterator j = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a8fbef6b38cae7e9f6220f1b08ab6a8e3">mySubscriptions</a>.begin(); j != <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a8fbef6b38cae7e9f6220f1b08ab6a8e3">mySubscriptions</a>.end();) {
<a name="l00655"></a>00655             <span class="keywordflow">if</span> ((*j).id == <span class="keywordtype">id</span> &amp;&amp; (*j).commandId == commandId) {
<a name="l00656"></a>00656                 j = <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a8fbef6b38cae7e9f6220f1b08ab6a8e3">mySubscriptions</a>.erase(j);
<a name="l00657"></a>00657                 found = <span class="keyword">true</span>;
<a name="l00658"></a>00658                 <span class="keywordflow">continue</span>;
<a name="l00659"></a>00659             }
<a name="l00660"></a>00660             ++j;
<a name="l00661"></a>00661         }
<a name="l00662"></a>00662         <span class="keywordflow">if</span> (found) {
<a name="l00663"></a>00663             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(commandId, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a541fc8755958a227fe412e2df7fa31fa">RTYPE_OK</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00664"></a>00664         } <span class="keywordflow">else</span> {
<a name="l00665"></a>00665             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(commandId, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a541fc8755958a227fe412e2df7fa31fa">RTYPE_OK</a>, <span class="stringliteral">&quot;The subscription to remove was not found.&quot;</span>);
<a name="l00666"></a>00666         }
<a name="l00667"></a>00667     } <span class="keywordflow">else</span> {
<a name="l00668"></a>00668         <span class="comment">// process subscription</span>
<a name="l00669"></a>00669         Subscription s(commandId, <span class="keywordtype">id</span>, variables, beginTime, endTime);
<a name="l00670"></a>00670         tcpip::Storage writeInto;
<a name="l00671"></a>00671         std::string errors;
<a name="l00672"></a>00672         <span class="keywordflow">if</span> (s.endTime &lt; <a class="code" href="../../dc/d5d/class_m_s_net.html#a2024ec4396b66fd698bb581fc5cc3408" title="Returns the pointer to the unique instance of MSNet (singleton).">MSNet::getInstance</a>()-&gt;<a class="code" href="../../dc/d5d/class_m_s_net.html#a835b8056e154e434da624033500e1943" title="Returns the current simulation step (in s).">getCurrentTimeStep</a>()) {
<a name="l00673"></a>00673             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aad2902b9f7df895e90c152c580ed877d">processSingleSubscription</a>(s, writeInto, errors);
<a name="l00674"></a>00674             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(s.commandId, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a43465ba21de31f9ae2573e7ac5f24919">RTYPE_ERR</a>, <span class="stringliteral">&quot;Subscription has ended.&quot;</span>);
<a name="l00675"></a>00675         } <span class="keywordflow">else</span> {
<a name="l00676"></a>00676             <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aad2902b9f7df895e90c152c580ed877d">processSingleSubscription</a>(s, writeInto, errors)) {
<a name="l00677"></a>00677                 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a8fbef6b38cae7e9f6220f1b08ab6a8e3">mySubscriptions</a>.push_back(s);
<a name="l00678"></a>00678                 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(s.commandId, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a541fc8755958a227fe412e2df7fa31fa">RTYPE_OK</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00679"></a>00679             } <span class="keywordflow">else</span> {
<a name="l00680"></a>00680                 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(s.commandId, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a43465ba21de31f9ae2573e7ac5f24919">RTYPE_ERR</a>, <span class="stringliteral">&quot;Could not add subscription (&quot;</span> + errors + <span class="stringliteral">&quot;).&quot;</span>);
<a name="l00681"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aad2902b9f7df895e90c152c580ed877d">00681</a>             }
<a name="l00682"></a>00682         }
<a name="l00683"></a>00683         <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a92cd157fe4df6c8b1522593d742cc31a">myOutputStorage</a>.writeStorage(writeInto);
<a name="l00684"></a>00684     }
<a name="l00685"></a>00685     <span class="keywordflow">return</span> ok;
<a name="l00686"></a>00686 }
<a name="l00687"></a>00687 
<a name="l00688"></a>00688 
<a name="l00689"></a>00689 <span class="keywordtype">bool</span>
<a name="l00690"></a>00690 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#aad2902b9f7df895e90c152c580ed877d">TraCIServer::processSingleSubscription</a>(<span class="keyword">const</span> Subscription&amp; s, tcpip::Storage&amp; writeInto,
<a name="l00691"></a>00691                                        std::string&amp; errors) {
<a name="l00692"></a>00692     <span class="keywordtype">bool</span> ok = <span class="keyword">true</span>;
<a name="l00693"></a>00693     tcpip::Storage outputStorage;
<a name="l00694"></a>00694     <span class="keywordflow">for</span> (std::vector&lt;int&gt;::const_iterator i = s.variables.begin(); i != s.variables.end(); ++i) {
<a name="l00695"></a>00695         tcpip::Storage message;
<a name="l00696"></a>00696         message.writeUnsignedByte(*i);
<a name="l00697"></a>00697         message.writeString(s.id);
<a name="l00698"></a>00698         tcpip::Storage tmpOutput;
<a name="l00699"></a>00699         <span class="keywordtype">int</span> getId = s.commandId - 0x30;
<a name="l00700"></a>00700         <span class="keywordflow">if</span> (<a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>.find(getId) != <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>.end()) {
<a name="l00701"></a>00701             ok &amp;= <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a241735bff3a2879512f32fbb60d535b9" title="Map of commandIds -&amp;gt; their executors; applicable if the executor applies to the...">myExecutors</a>[getId](*<span class="keyword">this</span>, message, tmpOutput);
<a name="l00702"></a>00702         } <span class="keywordflow">else</span> {
<a name="l00703"></a>00703             <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#a5c45d0ac74428278b8620033422dfbd6">writeStatusCmd</a>(s.commandId, <a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a31333391a4e82822d2c43e3928b6262c">RTYPE_NOTIMPLEMENTED</a>, <span class="stringliteral">&quot;Unsupported command specified&quot;</span>, tmpOutput);
<a name="l00704"></a>00704             ok = <span class="keyword">false</span>;
<a name="l00705"></a>00705         }
<a name="l00706"></a>00706         <span class="comment">// copy response part</span>
<a name="l00707"></a>00707         <span class="keywordflow">if</span> (ok) {
<a name="l00708"></a>00708             <span class="keywordtype">int</span> length = tmpOutput.readUnsignedByte();
<a name="l00709"></a>00709             <span class="keywordflow">while</span> (--length &gt; 0) {
<a name="l00710"></a>00710                 tmpOutput.readUnsignedByte();
<a name="l00711"></a>00711             }
<a name="l00712"></a>00712             <span class="keywordtype">int</span> lengthLength = 1;
<a name="l00713"></a>00713             length = tmpOutput.readUnsignedByte();
<a name="l00714"></a>00714             <span class="keywordflow">if</span> (length == 0) {
<a name="l00715"></a>00715                 lengthLength = 5;
<a name="l00716"></a>00716                 length = tmpOutput.readInt();
<a name="l00717"></a>00717             }
<a name="l00718"></a>00718             <span class="comment">//read responseType</span>
<a name="l00719"></a>00719             tmpOutput.readUnsignedByte();
<a name="l00720"></a>00720             <span class="keywordtype">int</span> variable = tmpOutput.readUnsignedByte();
<a name="l00721"></a>00721             std::string <span class="keywordtype">id</span> = tmpOutput.readString();
<a name="l00722"></a>00722             outputStorage.writeUnsignedByte(variable);
<a name="l00723"></a>00723             outputStorage.writeUnsignedByte(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a541fc8755958a227fe412e2df7fa31fa">RTYPE_OK</a>);
<a name="l00724"></a>00724             length -= (lengthLength + 1 + 4 + (int)<span class="keywordtype">id</span>.length());
<a name="l00725"></a>00725             <span class="keywordflow">while</span> (--length &gt; 0) {
<a name="l00726"></a>00726                 outputStorage.writeUnsignedByte(tmpOutput.readUnsignedByte());
<a name="l00727"></a>00727             }
<a name="l00728"></a>00728         } <span class="keywordflow">else</span> {
<a name="l00729"></a>00729             <span class="comment">//read length</span>
<a name="l00730"></a>00730             tmpOutput.readUnsignedByte();
<a name="l00731"></a>00731             <span class="comment">//read cmd</span>
<a name="l00732"></a>00732             tmpOutput.readUnsignedByte();
<a name="l00733"></a>00733             <span class="comment">//read status</span>
<a name="l00734"></a>00734             tmpOutput.readUnsignedByte();
<a name="l00735"></a>00735             std::string msg = tmpOutput.readString();
<a name="l00736"></a>00736             outputStorage.writeUnsignedByte(*i);
<a name="l00737"></a>00737             outputStorage.writeUnsignedByte(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a43465ba21de31f9ae2573e7ac5f24919">RTYPE_ERR</a>);
<a name="l00738"></a>00738             outputStorage.writeUnsignedByte(<a class="code" href="../../dd/dba/_tra_c_i_constants_8h.html#a4e4e428e3a6a191834e3ff63bd301866">TYPE_STRING</a>);
<a name="l00739"></a>00739             outputStorage.writeString(msg);
<a name="l00740"></a>00740             errors = errors + msg;
<a name="l00741"></a>00741         }
<a name="l00742"></a>00742     }
<a name="l00743"></a>00743     writeInto.writeUnsignedByte(0); <span class="comment">// command length -&gt; extended</span>
<a name="l00744"></a><a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#ad863107695199922e2dace0bbb517f2c">00744</a>     writeInto.writeInt((1 + 4) + 1 + (4 + (<span class="keywordtype">int</span>)(s.id.length())) + 1 + (int)outputStorage.size());
<a name="l00745"></a>00745     writeInto.writeUnsignedByte(s.commandId + 0x10);
<a name="l00746"></a>00746     writeInto.writeString(s.id);
<a name="l00747"></a>00747     writeInto.writeUnsignedByte((<span class="keywordtype">int</span>)(s.variables.size()));
<a name="l00748"></a>00748     writeInto.writeStorage(outputStorage);
<a name="l00749"></a>00749     <span class="keywordflow">return</span> ok;
<a name="l00750"></a>00750 }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752 <span class="keywordtype">void</span>
<a name="l00753"></a>00753 <a class="code" href="../../dc/d48/classtraci_1_1_tra_c_i_server.html#ad863107695199922e2dace0bbb517f2c">TraCIServer::writeResponseWithLength</a>(tcpip::Storage&amp; outputStorage, tcpip::Storage&amp; tempMsg) {
<a name="l00754"></a>00754     <span class="keywordflow">if</span> (tempMsg.size() &lt; 254) {
<a name="l00755"></a>00755         outputStorage.writeUnsignedByte(1 + (<span class="keywordtype">int</span>)tempMsg.size()); <span class="comment">// command length -&gt; short</span>
<a name="l00756"></a>00756     } <span class="keywordflow">else</span> {
<a name="l00757"></a>00757         outputStorage.writeUnsignedByte(0); <span class="comment">// command length -&gt; extended</span>
<a name="l00758"></a>00758         outputStorage.writeInt(1 + 4 + (<span class="keywordtype">int</span>)tempMsg.size());
<a name="l00759"></a>00759     }
<a name="l00760"></a>00760     outputStorage.writeStorage(tempMsg);
<a name="l00761"></a>00761 }
<a name="l00762"></a>00762 
<a name="l00763"></a>00763 }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765 <span class="preprocessor">#endif</span>
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Tue Jul 17 12:16:13 2012 for SUMO - Simulation of Urban MObility by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
